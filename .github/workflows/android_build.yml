name: Build Android APK

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # ---------------------------------------------------------
    # 1. SCAFFOLDING (CRIAR DIRETÓRIOS)
    # ---------------------------------------------------------
    - name: Create Directory Structure
      run: |
        mkdir -p app/src/main/cpp
        mkdir -p app/src/main/java/com/mednes/android
        mkdir -p app/src/main/res/layout
        mkdir -p app/src/main/res/values
        mkdir -p gradle/wrapper

    # ---------------------------------------------------------
    # 2. COPIAR CÓDIGO FONTE
    # ---------------------------------------------------------
    - name: Copy Source Core
      run: |
        cp -r Source/Core app/src/main/cpp/Core
        ls -R app/src/main/cpp/Core

    # ---------------------------------------------------------
    # 3. PATCH: REMOVER DEPENDÊNCIA DO SDL
    # ---------------------------------------------------------
    - name: Patch SDL Dependency
      run: |
        cat <<EOF > app/src/main/cpp/Core/Common/FakeSDL.hpp
        #pragma once
        #include <stdint.h>
        typedef int32_t SDL_Keycode;
        #define SDLK_a 97
        #define SDLK_b 98
        #define SDLK_SPACE 32
        #define SDLK_RETURN 13
        #define SDLK_UP 1073741906
        #define SDLK_DOWN 1073741905
        #define SDLK_LEFT 1073741904
        #define SDLK_RIGHT 1073741903
        EOF

        sed -i 's|#include <SDL.h>|#include "Common/FakeSDL.hpp"|g' app/src/main/cpp/Core/Controller.hpp

    # ---------------------------------------------------------
    # 4. CONFIGURAR GRADLE (VERSÕES ESTÁVEIS)
    # ---------------------------------------------------------
    - name: Generate Gradle Files
      run: |
        # settings.gradle
        cat <<EOF > settings.gradle
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "MedNES-Android"
        include ':app'
        EOF

        # build.gradle (Raiz) - Usando AGP 8.1.4 e Kotlin 1.9.0 (Combo Estável)
        cat <<EOF > build.gradle
        buildscript {
            repositories {
                google()
                mavenCentral()
            }
            dependencies {
                classpath 'com.android.tools.build:gradle:8.1.4'
                classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:1.9.0"
            }
        }
        // Plugins bloco vazio para compatibilidade com scripts antigos
        plugins {}
        EOF

        # app/build.gradle
        cat <<EOF > app/build.gradle
        plugins {
            id 'com.android.application'
            id 'kotlin-android'
        }

        android {
            namespace 'com.mednes.android'
            compileSdk 34

            defaultConfig {
                applicationId "com.mednes.android"
                minSdk 24
                targetSdk 34
                versionCode 1
                versionName "1.0"
                
                externalNativeBuild {
                    cmake {
                        cppFlags "-std=c++14"
                    }
                }
            }

            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
            }
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_1_8
                targetCompatibility JavaVersion.VERSION_1_8
            }
            kotlinOptions {
                jvmTarget = '1.8'
            }
            externalNativeBuild {
                cmake {
                    path "src/main/cpp/CMakeLists.txt"
                    version "3.22.1"
                }
            }
        }
        
        dependencies {
            implementation 'androidx.core:core-ktx:1.12.0'
            implementation 'androidx.appcompat:appcompat:1.6.1'
        }
        EOF

        # AndroidManifest.xml
        cat <<EOF > app/src/main/AndroidManifest.xml
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
            <uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE"/>
            <application
                android:label="MedNES"
                android:theme="@android:style/Theme.NoTitleBar.Fullscreen">
                <activity
                    android:name=".MainActivity"
                    android:exported="true"
                    android:screenOrientation="landscape">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF

    # ---------------------------------------------------------
    # 5. GERAR CÓDIGO C++ (JNI)
    # ---------------------------------------------------------
    - name: Generate C++ Files
      run: |
        # CMakeLists.txt
        cat <<EOF > app/src/main/cpp/CMakeLists.txt
        cmake_minimum_required(VERSION 3.18.1)
        project("mednes")

        add_library(
                mednes
                SHARED
                native-lib.cpp
                Core/6502.cpp
                Core/Controller.cpp
                Core/PPU.cpp
                Core/RAM.cpp
                Core/ROM.cpp
                Core/Mapper/CNROM.cpp
                Core/Mapper/Mapper.cpp
                Core/Mapper/MMC1.cpp
                Core/Mapper/NROM.cpp
                Core/Mapper/UnROM.cpp
        )

        target_include_directories(mednes PRIVATE Core)
        find_library(log-lib log)
        find_library(android-lib android)
        target_link_libraries(mednes \${log-lib} \${android-lib} jnigraphics)
        EOF

        # native-lib.cpp
        cat <<EOF > app/src/main/cpp/native-lib.cpp
        #include <jni.h>
        #include <string>
        #include <android/log.h>
        #include <android/bitmap.h>
        #include <cstring>
        #include "Core/6502.hpp"
        #include "Core/Controller.hpp"
        #include "Core/PPU.hpp"
        #include "Core/ROM.hpp"

        #define KEY_A 97
        #define KEY_B 98
        #define KEY_SELECT 32
        #define KEY_START 13
        #define KEY_UP 1073741906
        #define KEY_DOWN 1073741905
        #define KEY_LEFT 1073741904
        #define KEY_RIGHT 1073741903

        MedNES::ROM* objRom = nullptr;
        MedNES::Mapper* objMapper = nullptr;
        MedNES::PPU* objPpu = nullptr;
        MedNES::Controller* objController = nullptr;
        MedNES::CPU6502* objCpu = nullptr;

        extern "C" JNIEXPORT jboolean JNICALL
        Java_com_mednes_android_MedNESJni_loadRom(JNIEnv* env, jobject, jstring romPath) {
            const char *path = env->GetStringUTFChars(romPath, 0);
            if (objRom != nullptr) {
                if(objCpu) delete objCpu; 
                if(objController) delete objController; 
                if(objPpu) delete objPpu; 
                if(objMapper) delete objMapper; 
                if(objRom) delete objRom;
                objRom = nullptr; objCpu = nullptr;
            }
            objRom = new MedNES::ROM();
            try {
                objRom->open(std::string(path));
            } catch (...) {
                env->ReleaseStringUTFChars(romPath, path);
                return false;
            }
            objMapper = objRom->getMapper();
            if (!objMapper) {
                env->ReleaseStringUTFChars(romPath, path);
                return false;
            }
            objPpu = new MedNES::PPU(objMapper);
            objController = new MedNES::Controller();
            objCpu = new MedNES::CPU6502(objMapper, objPpu, objController);
            objCpu->reset();
            env->ReleaseStringUTFChars(romPath, path);
            return true;
        }

        extern "C" JNIEXPORT void JNICALL
        Java_com_mednes_android_MedNESJni_stepFrame(JNIEnv* env, jobject, jobject bitmap) {
            if (!objCpu || !objPpu) return;
            while (!objPpu->generateFrame) { objCpu->step(); }
            objPpu->generateFrame = false;
            void* pixels;
            if (AndroidBitmap_lockPixels(env, bitmap, &pixels) < 0) return;
            memcpy(pixels, objPpu->buffer, 256 * 240 * 4);
            AndroidBitmap_unlockPixels(env, bitmap);
        }

        extern "C" JNIEXPORT void JNICALL
        Java_com_mednes_android_MedNESJni_sendInput(JNIEnv* env, jobject, jint keyId, jboolean pressed) {
            if (!objController) return;
            int k = 0;
            switch(keyId) {
                case 0: k = KEY_A; break;
                case 1: k = KEY_B; break;
                case 2: k = KEY_SELECT; break;
                case 3: k = KEY_START; break;
                case 4: k = KEY_UP; break;
                case 5: k = KEY_DOWN; break;
                case 6: k = KEY_LEFT; break;
                case 7: k = KEY_RIGHT; break;
            }
            if (k != 0) objController->setButtonPressed(k, pressed);
        }
        EOF

    # ---------------------------------------------------------
    # 6. GERAR CÓDIGO KOTLIN (Interface)
    # ---------------------------------------------------------
    - name: Generate Kotlin UI
      run: |
        # MedNESJni.kt
        cat <<EOF > app/src/main/java/com/mednes/android/MedNESJni.kt
        package com.mednes.android
        import android.graphics.Bitmap
        object MedNESJni {
            init { System.loadLibrary("mednes") }
            external fun loadRom(path: String): Boolean
            external fun stepFrame(bitmap: Bitmap)
            external fun sendInput(keyId: Int, pressed: Boolean)
        }
        EOF

        # MainActivity.kt
        cat <<EOF > app/src/main/java/com/mednes/android/MainActivity.kt
        package com.mednes.android
        import android.graphics.Bitmap
        import android.os.Bundle
        import android.os.Handler
        import android.os.Looper
        import android.view.MotionEvent
        import android.widget.Button
        import android.widget.ImageView
        import android.widget.TextView
        import androidx.appcompat.app.AppCompatActivity
        import java.io.File
        import android.os.Environment

        class MainActivity : AppCompatActivity() {
            private lateinit var screen: ImageView
            private lateinit var status: TextView
            private var emuBitmap: Bitmap? = null
            private var isRunning = false
            private val handler = Handler(Looper.getMainLooper())
            
            override fun onCreate(savedInstanceState: Bundle?) {
                super.onCreate(savedInstanceState)
                setContentView(R.layout.activity_main)
                screen = findViewById(R.id.emulatorScreen)
                status = findViewById(R.id.statusText)
                
                emuBitmap = Bitmap.createBitmap(256, 240, Bitmap.Config.ARGB_8888)
                screen.setImageBitmap(emuBitmap)

                val downloadDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOWNLOADS)
                val romFile = File(downloadDir, "rom.nes")
                
                if (romFile.exists()) {
                    if (MedNESJni.loadRom(romFile.absolutePath)) {
                        isRunning = true
                        status.visibility = android.view.View.GONE
                        gameLoop()
                    } else {
                        status.text = "Failed to load ROM"
                    }
                } else {
                    status.text = "Place rom.nes in Downloads"
                }

                setupBtn(R.id.btnA, 0)
                setupBtn(R.id.btnB, 1)
                setupBtn(R.id.btnSelect, 2)
                setupBtn(R.id.btnStart, 3)
                setupBtn(R.id.btnUp, 4)
                setupBtn(R.id.btnDown, 5)
                setupBtn(R.id.btnLeft, 6)
                setupBtn(R.id.btnRight, 7)
            }
            
            private fun setupBtn(id: Int, key: Int) {
                val btn = findViewById<Button>(id)
                btn?.setOnTouchListener { _, event ->
                    if (event.action == MotionEvent.ACTION_DOWN) MedNESJni.sendInput(key, true)
                    if (event.action == MotionEvent.ACTION_UP) MedNESJni.sendInput(key, false)
                    true
                }
            }

            private fun gameLoop() {
                if (!isRunning) return
                MedNESJni.stepFrame(emuBitmap!!)
                screen.invalidate()
                handler.postDelayed({ gameLoop() }, 16)
            }
        }
        EOF

        # Layout XML
        cat <<EOF > app/src/main/res/layout/activity_main.xml
        <?xml version="1.0" encoding="utf-8"?>
        <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:background="#000000">
            
            <ImageView
                android:id="@+id/emulatorScreen"
                android:layout_width="match_parent"
                android:layout_height="match_parent"
                android:layout_centerInParent="true"
                android:scaleType="fitCenter" />
            
            <TextView
                android:id="@+id/statusText"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="Loading..."
                android:textColor="#FFFFFF"
                android:layout_centerInParent="true"/>

            <LinearLayout android:layout_width="wrap_content" android:layout_height="wrap_content"
                android:orientation="vertical" android:layout_alignParentBottom="true" android:layout_alignParentStart="true" android:padding="20dp">
                <Button android:id="@+id/btnUp" android:text="^" android:layout_width="60dp" android:layout_height="60dp" android:layout_gravity="center_horizontal"/>
                <LinearLayout android:layout_width="wrap_content" android:layout_height="wrap_content" android:orientation="horizontal">
                    <Button android:id="@+id/btnLeft" android:text="<" android:layout_width="60dp" android:layout_height="60dp"/>
                    <Button android:id="@+id/btnDown" android:text="v" android:layout_width="60dp" android:layout_height="60dp"/>
                    <Button android:id="@+id/btnRight" android:text=">" android:layout_width="60dp" android:layout_height="60dp"/>
                </LinearLayout>
            </LinearLayout>

            <LinearLayout android:layout_width="wrap_content" android:layout_height="wrap_content"
                android:orientation="horizontal" android:layout_alignParentBottom="true" android:layout_alignParentEnd="true" android:padding="30dp">
                <Button android:id="@+id/btnB" android:text="B" android:layout_width="70dp" android:layout_height="70dp" android:layout_marginEnd="10dp"/>
                <Button android:id="@+id/btnA" android:text="A" android:layout_width="70dp" android:layout_height="70dp"/>
            </LinearLayout>

             <LinearLayout android:layout_width="wrap_content" android:layout_height="wrap_content"
                android:orientation="horizontal" android:layout_alignParentBottom="true" android:layout_centerHorizontal="true" android:paddingBottom="10dp">
                <Button android:id="@+id/btnSelect" android:text="Sel" android:layout_width="wrap_content" android:layout_height="wrap_content"/>
                <Button android:id="@+id/btnStart" android:text="Sta" android:layout_width="wrap_content" android:layout_height="wrap_content"/>
            </LinearLayout>
        </RelativeLayout>
        EOF

    # ---------------------------------------------------------
    # 7. PREPARAR E COMPILAR (FORCE GRADLE 8.2)
    # ---------------------------------------------------------
    - name: Setup Gradle Wrapper 8.2
      run: |
        # FORÇAMOS A VERSÃO 8.2 AQUI. Isso corrige o erro "HasConvention"
        gradle wrapper --gradle-version 8.2

    - name: Build Debug APK
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug

    # ---------------------------------------------------------
    # 8. ARTEFATO
    # ---------------------------------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: MedNES-Android-APK
        path: app/build/outputs/apk/debug/app-debug.apk
