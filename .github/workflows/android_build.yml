name: Build Android APK

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # ---------------------------------------------------------
    # 1. CRIAR ESTRUTURA DE DIRETÓRIOS
    # ---------------------------------------------------------
    - name: Create Project Structure
      run: |
        mkdir -p app/src/main/cpp
        mkdir -p app/src/main/java/com/mednes/android
        mkdir -p app/src/main/res/layout
        mkdir -p app/src/main/res/values
        mkdir -p gradle/wrapper

    # ---------------------------------------------------------
    # 2. COPIAR O CORE DO MEDNES
    # ---------------------------------------------------------
    - name: Copy Source Core
      run: |
        # Copia a pasta Source/Core para dentro da pasta C++ do Android
        cp -r Source/Core app/src/main/cpp/Core
        ls -R app/src/main/cpp/Core

    # ---------------------------------------------------------
    # 3. PATCH: REMOVER DEPENDÊNCIA DO SDL
    # ---------------------------------------------------------
    - name: Patch SDL Dependency
      run: |
        # Cria FakeSDL.hpp
        cat <<EOF > app/src/main/cpp/Core/Common/FakeSDL.hpp
        #pragma once
        #include <stdint.h>
        typedef int32_t SDL_Keycode;
        #define SDLK_a 97
        #define SDLK_b 98
        #define SDLK_SPACE 32
        #define SDLK_RETURN 13
        #define SDLK_UP 1073741906
        #define SDLK_DOWN 1073741905
        #define SDLK_LEFT 1073741904
        #define SDLK_RIGHT 1073741903
        EOF

        # Substitui o include no Controller.hpp
        sed -i 's|#include <SDL.h>|#include "Common/FakeSDL.hpp"|g' app/src/main/cpp/Core/Controller.hpp

    # ---------------------------------------------------------
    # 4. GERAR GRADLE WRAPPER (Garante Gradle 8.5)
    # ---------------------------------------------------------
    - name: Generate Gradle Wrapper
      run: |
        cat <<EOF > gradle/wrapper/gradle-wrapper.properties
        distributionBase=GRADLE_USER_HOME
        distributionPath=wrapper/dists
        distributionUrl=https\://services.gradle.org/distributions/gradle-8.5-bin.zip
        zipStoreBase=GRADLE_USER_HOME
        zipStorePath=wrapper/dists
        EOF
        
        # Baixa o jar do wrapper para bootstrap (opcional, mas boa prática se não tiver)
        # O comando gradle wrapper do sistema vai gerar o jar
        gradle wrapper --gradle-version 8.5

    # ---------------------------------------------------------
    # 5. CRIAR ARQUIVOS DE BUILD (Sintaxe Moderna)
    # ---------------------------------------------------------
    - name: Create Build Files
      run: |
        # settings.gradle
        cat <<EOF > settings.gradle
        pluginManagement {
            repositories {
                google()
                mavenCentral()
                gradlePluginPortal()
            }
        }
        dependencyResolutionManagement {
            repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
            repositories {
                google()
                mavenCentral()
            }
        }
        rootProject.name = "MedNES-Android"
        include ':app'
        EOF

        # build.gradle (Raiz)
        cat <<EOF > build.gradle
        plugins {
            id 'com.android.application' version '8.2.0' apply false
            id 'org.jetbrains.kotlin.android' version '1.9.20' apply false
        }
        EOF

        # app/build.gradle
        cat <<EOF > app/build.gradle
        plugins {
            id 'com.android.application'
            id 'org.jetbrains.kotlin.android'
        }

        android {
            namespace 'com.mednes.android'
            compileSdk 34

            defaultConfig {
                applicationId "com.mednes.android"
                minSdk 24
                targetSdk 34
                versionCode 1
                versionName "1.0"
                
                externalNativeBuild {
                    cmake {
                        cppFlags "-std=c++14"
                    }
                }
            }

            buildTypes {
                release {
                    minifyEnabled false
                    proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
                }
            }
            compileOptions {
                sourceCompatibility JavaVersion.VERSION_1_8
                targetCompatibility JavaVersion.VERSION_1_8
            }
            kotlinOptions {
                jvmTarget = '1.8'
            }
            externalNativeBuild {
                cmake {
                    path "src/main/cpp/CMakeLists.txt"
                    version "3.22.1"
                }
            }
        }
        EOF

        # AndroidManifest.xml
        cat <<EOF > app/src/main/AndroidManifest.xml
        <?xml version="1.0" encoding="utf-8"?>
        <manifest xmlns:android="http://schemas.android.com/apk/res/android">
            <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
            <application
                android:label="MedNES"
                android:theme="@android:style/Theme.NoTitleBar.Fullscreen">
                <activity
                    android:name=".MainActivity"
                    android:exported="true"
                    android:screenOrientation="landscape">
                    <intent-filter>
                        <action android:name="android.intent.action.MAIN" />
                        <category android:name="android.intent.category.LAUNCHER" />
                    </intent-filter>
                </activity>
            </application>
        </manifest>
        EOF

    # ---------------------------------------------------------
    # 6. CRIAR CÓDIGO C++ (JNI)
    # ---------------------------------------------------------
    - name: Create C++ Native Interface
      run: |
        # CMakeLists.txt
        cat <<EOF > app/src/main/cpp/CMakeLists.txt
        cmake_minimum_required(VERSION 3.18.1)
        project("mednes")

        add_library(
                mednes
                SHARED
                native-lib.cpp
                Core/6502.cpp
                Core/Controller.cpp
                Core/PPU.cpp
                Core/RAM.cpp
                Core/ROM.cpp
                Core/Mapper/CNROM.cpp
                Core/Mapper/Mapper.cpp
                Core/Mapper/MMC1.cpp
                Core/Mapper/NROM.cpp
                Core/Mapper/UnROM.cpp
        )

        target_include_directories(mednes PRIVATE Core)
        find_library(log-lib log)
        find_library(android-lib android)
        # Linka a biblioteca jnigraphics necessária para manipular Bitmaps
        target_link_libraries(mednes \${log-lib} \${android-lib} jnigraphics)
        EOF

        # native-lib.cpp
        cat <<EOF > app/src/main/cpp/native-lib.cpp
        #include <jni.h>
        #include <string>
        #include <android/log.h>
        #include <android/bitmap.h>
        #include <cstring>
        #include "Core/6502.hpp"
        #include "Core/Controller.hpp"
        #include "Core/PPU.hpp"
        #include "Core/ROM.hpp"

        #define KEY_A 97
        #define KEY_B 98
        #define KEY_SELECT 32
        #define KEY_START 13
        #define KEY_UP 1073741906
        #define KEY_DOWN 1073741905
        #define KEY_LEFT 1073741904
        #define KEY_RIGHT 1073741903

        MedNES::ROM* objRom = nullptr;
        MedNES::Mapper* objMapper = nullptr;
        MedNES::PPU* objPpu = nullptr;
        MedNES::Controller* objController = nullptr;
        MedNES::CPU6502* objCpu = nullptr;

        extern "C" JNIEXPORT jboolean JNICALL
        Java_com_mednes_android_MedNESJni_loadRom(JNIEnv* env, jobject, jstring romPath) {
            const char *path = env->GetStringUTFChars(romPath, 0);
            if (objRom != nullptr) {
                delete objCpu; delete objController; delete objPpu; delete objMapper; delete objRom;
            }
            objRom = new MedNES::ROM();
            try {
                objRom->open(std::string(path));
            } catch (...) {
                return false;
            }
            objMapper = objRom->getMapper();
            if (!objMapper) return false;
            objPpu = new MedNES::PPU(objMapper);
            objController = new MedNES::Controller();
            objCpu = new MedNES::CPU6502(objMapper, objPpu, objController);
            objCpu->reset();
            env->ReleaseStringUTFChars(romPath, path);
            return true;
        }

        extern "C" JNIEXPORT void JNICALL
        Java_com_mednes_android_MedNESJni_stepFrame(JNIEnv* env, jobject, jobject bitmap) {
            if (!objCpu) return;
            while (!objPpu->generateFrame) { objCpu->step(); }
            objPpu->generateFrame = false;

            void* pixels;
            if (AndroidBitmap_lockPixels(env, bitmap, &pixels) < 0) return;
            
            // MedNES buffer: uint32_t (ARGB ou ABGR dependendo da endianess)
            // Copia direta para o Bitmap
            memcpy(pixels, objPpu->buffer, 256 * 240 * 4);
            
            AndroidBitmap_unlockPixels(env, bitmap);
        }

        extern "C" JNIEXPORT void JNICALL
        Java_com_mednes_android_MedNESJni_sendInput(JNIEnv* env, jobject, jint keyId, jboolean pressed) {
            if (!objController) return;
            int k = 0;
            switch(keyId) {
                case 0: k = KEY_A; break;
                case 1: k = KEY_B; break;
                case 2: k = KEY_SELECT; break;
                case 3: k = KEY_START; break;
                case 4: k = KEY_UP; break;
                case 5: k = KEY_DOWN; break;
                case 6: k = KEY_LEFT; break;
                case 7: k = KEY_RIGHT; break;
            }
            if (k != 0) objController->setButtonPressed(k, pressed);
        }
        EOF

    # ---------------------------------------------------------
    # 7. CRIAR CÓDIGO KOTLIN (UI)
    # ---------------------------------------------------------
    - name: Create Kotlin UI
      run: |
        # JNI Wrapper
        cat <<EOF > app/src/main/java/com/mednes/android/MedNESJni.kt
        package com.mednes.android
        import android.graphics.Bitmap
        object MedNESJni {
            init { System.loadLibrary("mednes") }
            external fun loadRom(path: String): Boolean
            external fun stepFrame(bitmap: Bitmap)
            external fun sendInput(keyId: Int, pressed: Boolean)
        }
        EOF

        # MainActivity
        cat <<EOF > app/src/main/java/com/mednes/android/MainActivity.kt
        package com.mednes.android
        import android.graphics.Bitmap
        import android.os.Bundle
        import android.os.Handler
        import android.os.Looper
        import android.view.MotionEvent
        import android.widget.Button
        import android.widget.ImageView
        import android.widget.TextView
        import androidx.appcompat.app.AppCompatActivity
        import java.io.File

        class MainActivity : AppCompatActivity() {
            private lateinit var screen: ImageView
            private lateinit var status: TextView
            private var emuBitmap: Bitmap? = null
            private var isRunning = false
            private val handler = Handler(Looper.getMainLooper())
            
            override fun onCreate(savedInstanceState: Bundle?) {
                super.onCreate(savedInstanceState)
                setContentView(R.layout.activity_main)
                screen = findViewById(R.id.emulatorScreen)
                status = findViewById(R.id.statusText)
                
                emuBitmap = Bitmap.createBitmap(256, 240, Bitmap.Config.ARGB_8888)
                screen.setImageBitmap(emuBitmap)

                // Procura ROM no armazenamento externo padrão
                val path = "/sdcard/Download/rom.nes" 
                val file = File(path)
                
                if (file.exists()) {
                    if (MedNESJni.loadRom(path)) {
                        isRunning = true
                        status.visibility = android.view.View.GONE
                        gameLoop()
                    } else {
                        status.text = "Load Failed"
                    }
                } else {
                    status.text = "Place ROM at: /sdcard/Download/rom.nes"
                }

                setupBtn(R.id.btnA, 0)
                setupBtn(R.id.btnB, 1)
                setupBtn(R.id.btnSelect, 2)
                setupBtn(R.id.btnStart, 3)
                setupBtn(R.id.btnUp, 4)
                setupBtn(R.id.btnDown, 5)
                setupBtn(R.id.btnLeft, 6)
                setupBtn(R.id.btnRight, 7)
            }
            
            private fun setupBtn(id: Int, key: Int) {
                val btn = findViewById<Button>(id)
                if (btn != null) {
                    btn.setOnTouchListener { _, event ->
                        if (event.action == MotionEvent.ACTION_DOWN) MedNESJni.sendInput(key, true)
                        if (event.action == MotionEvent.ACTION_UP) MedNESJni.sendInput(key, false)
                        true
                    }
                }
            }

            private fun gameLoop() {
                if (!isRunning) return
                MedNESJni.stepFrame(emuBitmap!!)
                screen.invalidate()
                handler.postDelayed({ gameLoop() }, 16)
            }
        }
        EOF

        # Layout XML (Completo com D-PAD)
        cat <<EOF > app/src/main/res/layout/activity_main.xml
        <?xml version="1.0" encoding="utf-8"?>
        <RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
            android:layout_width="match_parent"
            android:layout_height="match_parent"
            android:background="#000000">
            
            <ImageView
                android:id="@+id/emulatorScreen"
                android:layout_width="match_parent"
                android:layout_height="match_parent"
                android:layout_centerInParent="true"
                android:scaleType="fitCenter" />
            
            <TextView
                android:id="@+id/statusText"
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:text="Loading..."
                android:textColor="#FFFFFF"
                android:layout_centerInParent="true"/>

            <!-- D-PAD (Esquerda) -->
            <LinearLayout
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:orientation="vertical"
                android:layout_alignParentBottom="true"
                android:layout_alignParentStart="true"
                android:padding="20dp">
                <Button android:id="@+id/btnUp" android:text="^" android:layout_width="60dp" android:layout_height="60dp" android:layout_gravity="center_horizontal"/>
                <LinearLayout android:layout_width="wrap_content" android:layout_height="wrap_content" android:orientation="horizontal">
                    <Button android:id="@+id/btnLeft" android:text="&lt;" android:layout_width="60dp" android:layout_height="60dp"/>
                    <Button android:id="@+id/btnDown" android:text="v" android:layout_width="60dp" android:layout_height="60dp"/>
                    <Button android:id="@+id/btnRight" android:text="&gt;" android:layout_width="60dp" android:layout_height="60dp"/>
                </LinearLayout>
            </LinearLayout>

            <!-- Botões de Ação (Direita) -->
            <LinearLayout
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:orientation="horizontal"
                android:layout_alignParentBottom="true"
                android:layout_alignParentEnd="true"
                android:padding="30dp">
                <Button android:id="@+id/btnB" android:text="B" android:layout_width="70dp" android:layout_height="70dp" android:layout_marginEnd="10dp"/>
                <Button android:id="@+id/btnA" android:text="A" android:layout_width="70dp" android:layout_height="70dp"/>
            </LinearLayout>

            <!-- Select / Start (Centro) -->
             <LinearLayout
                android:layout_width="wrap_content"
                android:layout_height="wrap_content"
                android:orientation="horizontal"
                android:layout_alignParentBottom="true"
                android:layout_centerHorizontal="true"
                android:paddingBottom="10dp">
                <Button android:id="@+id/btnSelect" android:text="Sel" android:layout_width="wrap_content" android:layout_height="wrap_content" android:textSize="10sp"/>
                <Button android:id="@+id/btnStart" android:text="Sta" android:layout_width="wrap_content" android:layout_height="wrap_content" android:textSize="10sp"/>
            </LinearLayout>

        </RelativeLayout>
        EOF

    # ---------------------------------------------------------
    # 8. COMPILAR (Usando ./gradlew)
    # ---------------------------------------------------------
    - name: Build with Gradle
      run: |
        chmod +x gradlew
        ./gradlew assembleDebug

    # ---------------------------------------------------------
    # 9. UPLOAD DO APK (v4)
    # ---------------------------------------------------------
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: MedNES-Android-APK
        path: app/build/outputs/apk/debug/app-debug.apk
